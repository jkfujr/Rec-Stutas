<!DOCTYPE html>
<html lang="zh-Hans-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å½•æ’­çŠ¶æ€</title>
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* å“åº”å¼ */
        @media (max-width: 48rem) {
            #main-container {
                flex-direction: column;
            }

            #user-list,
            #details {
                max-height: 50vh;
                min-width: 100%;
            }
        }

        /* åŸºç¡€æ ·å¼ */
        html {
            color: #1F2021;
        }

        body {
            position: relative;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", STHeiti, "Microsoft YaHei", SimSun, sans-serif;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://t.mwm.moe/ycy/');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.2;
            z-index: -1;
        }

        #main-container {
            display: flex;
            height: auto;
            min-height: 100%;
            overflow: hidden;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, .15);
            z-index: 3;
        }

        /* é€æ˜æ•ˆæœ - å¯¼èˆªæ  */
        .navbar-blur-mode {
            background: transparent !important;
            background: rgba(255, 255, 255, .9rem) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            background-color: #f5f5f5;
            box-shadow: 2px 0 8px rgba(0, 0, 0, .15);
            z-index: 2;
        }

        /* é€æ˜æ•ˆæœ - ä¾§è¾¹æ  */
        .sidebar-blur-mode {
            background: transparent !important;
            background: rgba(255, 255, 255, .9rem) !important;
            backdrop-filter: saturate(150%) blur(12px) !important;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            flex-shrink: 0;
            position: sticky;
            top: 0;
            padding: 5px;
            background-color: transparent;
            z-index: 100;
        }

        #userSearch {
            width: 100%;
            padding: .3125rem;
            margin-bottom: .3125rem;
            border: .0625rem solid #dddddd;
            border-radius: .25rem;
            background-color: transparent;
            color: black;
        }

        /* ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .user-stats {
            padding: .3125rem;
            background-color: transparent;
            border-radius: .125rem;
            margin-bottom: .3125rem;
            text-align: center;
        }

        .user-stats p {
            margin-bottom: 0rem;
            font-size: 1.375rem !important;
        }

        /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
        .user-item {
            cursor: pointer;
            padding: .3125rem;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        #user-list {
            flex: 0 0 auto;
            min-width: max-content;
            overflow-y: auto;
            background-color: transparent;
            padding: .3125rem;
            max-height: calc(100vh - 11.75rem);
            min-height: calc(100vh - 11.75rem);
        }

        /* ç›´æ’­ä¸­ç”¨æˆ·çš„æ ·å¼ */
        .streaming {
            border: .0625rem solid #dc6565;
            border-radius: .625rem;
            box-shadow: 0 .125rem .25rem #00000033;
        }

        /* å›¾æ ‡æ ·å¼ */
        .recheme-icon,
        .blrec-icon {
            width: 1rem;
            height: 1rem;
            margin-right: .3125rem;
            border-radius: 50%;
        }

        .recheme-icon {
            background-color: #1C9BCD;
        }

        .blrec-icon {
            background-color: #F85B64;
        }

        /* è¯¦æƒ…åŒºåŸŸ */
        .details {
            flex-grow: 1;
            max-height: calc(100vh - 56px);
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: .625rem;
            color: #1F2021;
            z-index: 1;
        }

        /* lighté€æ˜æ•ˆæœ - è¯¦æƒ…åŒºåŸŸ */
        .details-blur-mode {
            background: transparent !important;
        }


        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: .625rem;
        }

        ::-webkit-scrollbar-track {
            background: #E4E4E5;
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: #343941;
        }

        ::-webkit-scrollbar-thumb {
            background: #0088FF;
            border-radius: .3125rem;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #0088FF;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1A94FF;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #1A94FF;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .dark-mode {
            background-color: #1F2021;
            color: #ffffff;
        }

        .dark-mode #sidebar,
        .dark-mode #details {
            background-color: #1F2021;
            color: #ffffff;
        }

        .dark-mode .navbar,
        .dark-mode .navbar-light .navbar-nav .nav-link,
        .dark-mode .navbar-light .navbar-nav .nav-link:hover {
            background-color: #1F2021;
            color: rgba(255, 255, 255, 0.9);
        }

        .dark-mode .navbar-toggler-icon {
            filter: invert(1);
        }

        /* ä¸‹æ‹‰èœå•æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark-mode .dropdown-menu,
        .dark-mode .dropdown-menu .dropdown-item,
        .dark-mode .dropdown-menu .dropdown-item:hover,
        .dark-mode .dropdown-menu .dropdown-item:focus {
            background-color: #343a40;
            color: #ffffff;
        }

        /* å›¾æ ‡é¢œè‰²æ ·å¼ */
        .theme-icon-light,
        .dropdown-icon-light {
            filter: invert(0%);
        }

        .theme-icon-dark,
        .dropdown-icon-dark {
            filter: invert(100%);
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">å½•æ’­çŠ¶æ€</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/api/data">APIå–µ</a>
                        </li>
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">GitHubå–µ(è¿˜æ²¡æœ‰å–µ)</a>
                        </li>
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">æµ‹è¯•ä¸­å–µ</a></li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="btn btn-outline-secondary" href="#" id="themeDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <img id="themeIcon" src="./assets/img/sun-fill.svg" alt="Theme Icon"
                                    style="width: 1.25rem; height: 1.25rem;">
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
                                <li><a class="dropdown-item" onclick="setTheme('light')">
                                        <img src="./assets/img/sun-fill.svg" alt="Sun Icon"
                                            style="width: 1.25rem; height: 1.25rem; margin-right: .3125rem;">Light
                                    </a></li>
                                <li><a class="dropdown-item" onclick="setTheme('dark')">
                                        <img src="./assets/img/moon-stars-fill.svg" alt="Moon Icon"
                                            style="width: 1.25rem; height: 1.25rem; margin-right: .3125rem;">Dark
                                    </a></li>
                                <li>
                                    <a class="dropdown-item">
                                        <input type="checkbox" id="blurEffectToggle" onchange="toggleBlurEffect()">
                                        <label for="blurEffectToggle">æ¯›ç»ç’ƒ</label>
                                    </a>
                                </li>

                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container-fluid">
        <div class="row" id="main-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar col-md-3" id="sidebar">
                <!-- æœç´¢æ¡† -->
                <div class="search-container" id="search-container">
                    <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·..." onkeyup="filterUsers()">
                </div>
                <!-- çŠ¶æ€æ  -->
                <div id="user-stats" class="user-stats">
                    <p>ç›‘æ§ä¸­ <span id="total-users">0</span></p>
                    <p>ç›´æ’­ä¸­ <span id="streaming-users">0</span></p>
                </div>
                <!-- ç”¨æˆ·åˆ—è¡¨å†…å®¹ -->
                <div id="user-list"></div>
            </div>
            <!-- è¯¦ç»†ä¿¡æ¯åŒºåŸŸ -->
            <section class="details col-md-9" id="details">
                ç‚¹å‡»å·¦ä¾§ç”¨æˆ·åä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚
            </section>
        </div>
    </main>

    <script src="./assets/js/bootstrap.bundle.min.js"></script>
    <script>
        // å¸¸ç”¨ç¼“å­˜
        const body = document.body;
        const navbar = document.querySelector('.navbar');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const dropdownIcons = document.querySelectorAll('.dropdown-menu img');
        const details = document.getElementById('details');
        const userList = document.getElementById('user-list');

        // ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        const setTheme = (theme) => {
            const isDark = theme === 'dark';
            body.classList.toggle('dark-mode', isDark);
            navbar.classList.replace(isDark ? 'bg-light' : 'bg-dark', isDark ? 'bg-dark' : 'bg-light');
            navbar.classList.replace(isDark ? 'navbar-light' : 'navbar-dark', isDark ? 'navbar-dark' : 'navbar-light');
            themeIcon.src = isDark ? "./assets/img/moon-stars-fill.svg" : "./assets/img/sun-fill.svg";
            themeIcon.className = isDark ? 'theme-icon-dark' : 'theme-icon-light';
            dropdownIcons.forEach(icon => icon.className = isDark ? 'dropdown-icon-dark' : 'dropdown-icon-light');
            localStorage.setItem('theme', theme);
        };
        // åˆ‡æ¢é€æ˜æ•ˆæœ
        function toggleBlurEffect() {
            const isChecked = document.getElementById('blurEffectToggle').checked;
            localStorage.setItem('blurEffect', isChecked);
            applyBlurEffect(isChecked);
        }

        // åº”ç”¨é€æ˜æ•ˆæœ
        function applyBlurEffect(enabled) {
            const navbar = document.querySelector('.navbar');
            const sidebar = document.getElementById('sidebar');
            const details = document.getElementById('details');

            navbar.classList.toggle('navbar-blur-mode', enabled);
            sidebar.classList.toggle('sidebar-blur-mode', enabled);
            details.classList.toggle('details-blur-mode', enabled);
        }

        // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const blurEffectEnabled = localStorage.getItem('blurEffect') === 'true';
            document.getElementById('blurEffectToggle').checked = blurEffectEnabled;
            setTheme(savedTheme);
            applyBlurEffect(blurEffectEnabled);
        });


        // è·å–å¹¶æ˜¾ç¤ºæˆ¿é—´æ•°æ®
        const fetchRoomData = async (roomId, rectpye) => {
            try {
                const response = await fetch(`/api/data/${rectpye}/${roomId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // å‡è®¾æ•°æ®åœ¨dataå±æ€§ä¸‹ï¼Œæ ¹æ®ä½ çš„å®é™…æ•°æ®ç»“æ„è°ƒæ•´
                displayUserData(data.data[0]);
            } catch (error) {
                console.error('Error fetching room data:', error);
                details.innerHTML = `<p>æ— æ³•åŠ è½½æ•°æ®: ${error.message}</p>`;
            }
        };

        // æ ¼å¼åŒ–å¹¶å±•ç¤ºç”¨æˆ·æ•°æ®
        function displayUserData(userData) {
            let formattedData = '';
            if (userData.rectpye === 'recheme') {
                formattedData = formatRechemeData(userData);
            } else if (userData.rectpye === 'blrec') {
                formattedData = formatBlrecData(userData);
            }

            const rawData = JSON.stringify(userData, null, 2);
            details.innerHTML = `
        <div class="formatted-data">${formattedData}</div>
        <details>
            <summary>åŸå§‹æ•°æ®</summary>
            <pre><code>${rawData}</code></pre>
        </details>
    `;
        }

        // æ ¼å¼åŒ–'recheme'ç±»å‹çš„æ•°æ®
        function formatRechemeData(data) {
            return `
        <div class="data-item">${data.title}</div>
        <hr>
        <div class="data-item">${data.name} Â· <a href="https://live.bilibili.com/${data.roomId}" target="_blank">${data.roomId}</a></div>
        <div class="data-item">${data.areaNameParent} - ${data.areaNameChild}</div>
        <div class="data-item">UID <a href="https://space.bilibili.com/${data.uid}" target="_blank">${data.uid}</a></div>
        <div class="data-item">ç›´æ’­çŠ¶æ€ ${data.streaming ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">è‡ªåŠ¨å½•æ’­ ${data.autoRecord ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
    `;
        }


        // æ ¼å¼åŒ–'blrec'ç±»å‹çš„æ•°æ®
        function formatBlrecData(data) {
            return `
        <div class="data-item">${data.room_info.title}</div>
        <hr>
        <div class="data-item">${data.user_info.name}Â·${data.room_info.room_id}</div>
        <div class="data-item">UID: ${data.user_info.uid}</div>
        <div class="data-item">ä¸»æ’­ç±»å‹: ${data.room_info.parent_area_name} - ${data.room_info.area_name}</div>

        <div class="data-item">æ˜¯å¦æ­£åœ¨ç›´æ’­: ${data.room_info.live_status === 1 ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">åœ¨çº¿äººæ•°: ${data.room_info.online}</div>
    `;
        }



        // åˆ¤æ–­æ˜¯å¦æ­£åœ¨ç›´æ’­
        const isStreaming = (user) => {
            if (user.rectpye === 'recheme') {
                return user.streaming;
            } else if (user.rectpye === 'blrec') {
                return user.room_info.live_status === 1;
            }
            return false;
        };

        // æ¯”è¾ƒå‡½æ•°ï¼Œç”¨äºæ’åº
        const compareUsers = (a, b) => {
            const streamingA = isStreaming(a) ? 0 : 1;
            const streamingB = isStreaming(b) ? 0 : 1;

            if (streamingA !== streamingB) {
                return streamingA - streamingB;
            }

            const nameA = a.rectpye === 'recheme' ? a.name : a.user_info.name;
            const nameB = b.rectpye === 'recheme' ? b.name : b.user_info.name;
            return nameA.localeCompare(nameB, ['en', 'ja', 'zh-Hans-CN'], { sensitivity: 'accent' });
        };

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        const loadUserList = async () => {
            const response = await fetch('/api/data');
            const { data } = await response.json();
            data.sort(compareUsers);

            // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('total-users').textContent = data.length;

            // åˆ›å»ºä¸€ä¸ªé›†åˆå­˜å‚¨ç›´æ’­ä¸­çš„ç‹¬ç‰¹ç”¨æˆ·å
            const streamingUsersSet = new Set();
            data.forEach(user => {
                if (isStreaming(user)) {
                    const name = user.rectpye === 'recheme' ? user.name : user.user_info.name;
                    streamingUsersSet.add(name);
                }
            });

            // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('total-users').textContent = data.length;
            const streamingCount = data.filter(user => isStreaming(user)).length;
            document.getElementById('streaming-users').textContent = streamingUsersSet.size;
            userList.innerHTML = data.map(user => {
                const name = user.rectpye === 'recheme' ? user.name : user.user_info.name;
                const iconClass = user.rectpye === 'recheme' ? 'recheme-icon' : 'blrec-icon';
                const streamingClass = isStreaming(user) ? 'streaming' : '';
                return `<div class="user-item ${streamingClass}" onclick="fetchRoomData('${user.rectpye === 'recheme' ? user.roomId : user.room_info.room_id}', '${user.rectpye}')">
                        <div class="${iconClass}"></div>${name}
                    </div>`;
            }).join('');
        };
        loadUserList();

        // æœç´¢æ¡†
        function filterUsers() {
            const filter = document.getElementById('userSearch').value.toLowerCase();
            const userItems = userList.getElementsByClassName('user-item');

            for (const item of userItems) {
                const isVisible = item.textContent.toLowerCase().includes(filter);
                item.style.display = isVisible ? "" : "none";
            }
        }

    </script>

</body>

</html>