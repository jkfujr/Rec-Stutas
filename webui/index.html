<!DOCTYPE html>
<html lang="zh-Hans-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å½•æ’­çŠ¶æ€</title>
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* å“åº”å¼ */
        @media (max-width: 48rem) {
            #main-container {
                flex-direction: column;
            }

            #user-list,
            #details {
                max-height: 50vh;
                min-width: 100%;
            }
        }

        /* åŸºç¡€æ ·å¼ */
        html {
            color: #1F2021;
        }

        body {
            position: relative;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", STHeiti, "Microsoft YaHei", SimSun, sans-serif;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://t.mwm.moe/ycy/');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.2;
            z-index: -1;
        }

        #main-container {
            display: flex;
            height: auto;
            min-height: 100%;
            overflow: hidden;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            box-shadow: 0 .125rem .5rem rgba(0, 0, 0, .15);
            z-index: 3;
        }

        /* é€æ˜æ•ˆæœ - å¯¼èˆªæ  */
        .navbar-blur-mode {
            background: transparent !important;
            background: rgba(255, 255, 255, .9rem) !important;
            backdrop-filter: blur(.5rem) !important;
            -webkit-backdrop-filter: blur(.5rem) !important;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            background-color: #f5f5f5;

            z-index: 2;
        }

        /* é€æ˜æ•ˆæœ - ä¾§è¾¹æ  */
        .sidebar-blur-mode {
            background: transparent !important;
            background: rgba(255, 255, 255, .9rem) !important;
            backdrop-filter: saturate(150%) blur(.75rem) !important;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            flex-shrink: 0;
            position: sticky;
            top: 0;
            padding: .3125rem;
            background-color: transparent;
            z-index: 100;
        }

        #userSearch {
            width: 100%;
            padding: .3125rem;
            margin-bottom: .3125rem;
            border: .0625rem solid #dddddd;
            border-radius: .25rem;
            background-color: transparent;
            color: black;
        }

        /* ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .user-stats {
            padding: .3125rem;
            background-color: transparent;
            border-radius: .125rem;
            margin-bottom: .3125rem;
            text-align: center;
        }

        .user-stats p {
            margin-bottom: 0rem;
            font-size: 1.375rem !important;
        }

        /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
        .user-item {
            cursor: pointer;
            padding: .3125rem;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        #user-list {
            flex: 0 0 auto;
            min-width: max-content;
            overflow-y: auto;
            background-color: transparent;
            padding: .3125rem;
            max-height: calc(100vh - 11.75rem);
            min-height: calc(100vh - 11.75rem);
        }

        /* ç›´æ’­ä¸­ç”¨æˆ·çš„æ ·å¼ */
        .streaming {
            border: .0625rem solid #dc6565;
            border-radius: .625rem;
            box-shadow: 0 .125rem .25rem #00000033;
        }

        /* å›¾æ ‡æ ·å¼ */
        .recheme-icon,
        .blrec-icon {
            width: 1rem;
            height: 1rem;
            margin-right: .3125rem;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .recheme-icon {
            background-image: url('./assets/img/recheme.svg');
        }

        .blrec-icon {
            background-image: url('./assets/img/blrec.png');
            /* è®¾ç½®blrecå›¾æ ‡ */
        }


        /* è¯¦æƒ…åŒºåŸŸ */
        .details {
            flex-grow: 1;
            max-height: calc(100vh - 3.5rem);
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: .625rem;
            color: #1F2021;
            z-index: 1;
        }

        /* lighté€æ˜æ•ˆæœ - è¯¦æƒ…åŒºåŸŸ */
        .details-blur-mode {
            background: transparent !important;
        }

        /* åˆ†é¡µæ ‡ç­¾åŸºæœ¬æ ·å¼ */
        .nav-tabs {
            border-bottom: none;
            padding: 0.5rem;
        }

        .nav-tabs .nav-link {
            border: .0625rem solid transparent;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #f8f9fa;
            color: #007bff;
        }

        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #ddd #ddd #fff;
        }

        /* å…¼å®¹ blur-mode çš„æ ·å¼ */
        .dark-mode .nav-tabs .nav-link {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .dark-mode .nav-tabs .nav-link.active {
            background-color: rgba(255, 255, 255, 0.3);
        }



        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: .625rem;
        }

        ::-webkit-scrollbar-track {
            background: #E4E4E5;
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: #343941;
        }

        ::-webkit-scrollbar-thumb {
            background: #0088FF;
            border-radius: .3125rem;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #0088FF;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1A94FF;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #1A94FF;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .dark-mode {
            background-color: #1F2021;
            color: #ffffff;
        }

        .dark-mode #sidebar,
        .dark-mode #details {
            background-color: #1F2021;
            color: #ffffff;
        }

        .dark-mode .navbar,
        .dark-mode .navbar-light .navbar-nav .nav-link,
        .dark-mode .navbar-light .navbar-nav .nav-link:hover {
            background-color: #1F2021;
            color: rgba(255, 255, 255, 0.9);
        }

        .dark-mode .navbar-toggler-icon {
            filter: invert(1);
        }

        /* ä¸‹æ‹‰èœå•æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark-mode .dropdown-menu,
        .dark-mode .dropdown-menu .dropdown-item,
        .dark-mode .dropdown-menu .dropdown-item:hover,
        .dark-mode .dropdown-menu .dropdown-item:focus {
            background-color: #343a40;
            color: #ffffff;
        }

        /* å›¾æ ‡é¢œè‰²æ ·å¼ */
        .theme-icon-light,
        .dropdown-icon-light {
            filter: invert(0%);
        }

        .theme-icon-dark,
        .dropdown-icon-dark {
            filter: invert(100%);
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">å½•æ’­çŠ¶æ€</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/api/data"
                                target="_blank">APIå–µ</a></li>
                        <li class="nav-item"><a class="nav-link active" aria-current="page"
                                href="https://github.com/jkfujr/Rec-Stutas" target="_blank">GitHubå–µ</a></li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="btn btn-outline-secondary" href="#" id="themeDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <img id="themeIcon" src="./assets/img/sun-fill.svg" alt="Theme Icon"
                                    style="width: 1.25rem; height: 1.25rem;">
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
                                <li><a class="dropdown-item" onclick="setTheme('light')">
                                        <img src="./assets/img/sun-fill.svg" alt="Sun Icon"
                                            style="width: 1.25rem; height: 1.25rem; margin-right: .3125rem;">Light
                                    </a></li>
                                <li><a class="dropdown-item" onclick="setTheme('dark')">
                                        <img src="./assets/img/moon-stars-fill.svg" alt="Moon Icon"
                                            style="width: 1.25rem; height: 1.25rem; margin-right: .3125rem;">Dark
                                    </a></li>
                                <li>
                                    <a class="dropdown-item">
                                        <input type="checkbox" id="blurEffectToggle" onchange="toggleBlurEffect()">
                                        <label for="blurEffectToggle">æ¯›ç»ç’ƒ</label>
                                    </a>
                                </li>

                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container-fluid">
        <div class="row" id="main-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar col-md-3" id="sidebar">
                <!-- æœç´¢æ¡† -->
                <div class="search-container" id="search-container">
                    <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·..." onkeyup="filterUsers()">
                </div>
                <!-- çŠ¶æ€æ  -->
                <div id="user-stats" class="user-stats">
                    <p>ç›‘æ§ä¸­ <span id="total-users">0</span></p>
                    <p>ç›´æ’­ä¸­ <span id="streaming-users">0</span></p>
                </div>
                <!-- ç”¨æˆ·åˆ—è¡¨å†…å®¹ -->
                <div id="user-list"></div>
            </div>
            <!-- è¯¦ç»†ä¿¡æ¯åŒºåŸŸ -->
            <section class="details col-md-9" id="details">
                ç‚¹å‡»å·¦ä¾§ç”¨æˆ·åä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚
            </section>
        </div>
    </main>

    <script src="./assets/js/bootstrap.bundle.min.js"></script>
    <script>
        // å¸¸ç”¨ç¼“å­˜
        const body = document.body;
        const navbar = document.querySelector('.navbar');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const dropdownIcons = document.querySelectorAll('.dropdown-menu img');
        const details = document.getElementById('details');
        const userList = document.getElementById('user-list');

        // ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        const setTheme = (theme) => {
            const isDark = theme === 'dark';
            body.classList.toggle('dark-mode', isDark);
            navbar.classList.replace(isDark ? 'bg-light' : 'bg-dark', isDark ? 'bg-dark' : 'bg-light');
            navbar.classList.replace(isDark ? 'navbar-light' : 'navbar-dark', isDark ? 'navbar-dark' : 'navbar-light');
            themeIcon.src = isDark ? "./assets/img/moon-stars-fill.svg" : "./assets/img/sun-fill.svg";
            themeIcon.className = isDark ? 'theme-icon-dark' : 'theme-icon-light';
            dropdownIcons.forEach(icon => icon.className = isDark ? 'dropdown-icon-dark' : 'dropdown-icon-light');
            localStorage.setItem('theme', theme);
        };
        // åˆ‡æ¢é€æ˜æ•ˆæœ
        function toggleBlurEffect() {
            const isChecked = document.getElementById('blurEffectToggle').checked;
            localStorage.setItem('blurEffect', isChecked);
            applyBlurEffect(isChecked);
        }

        // åº”ç”¨é€æ˜æ•ˆæœ
        function applyBlurEffect(enabled) {
            const navbar = document.querySelector('.navbar');
            const sidebar = document.getElementById('sidebar');
            const details = document.getElementById('details');

            navbar.classList.toggle('navbar-blur-mode', enabled);
            sidebar.classList.toggle('sidebar-blur-mode', enabled);
            details.classList.toggle('details-blur-mode', enabled);
        }

        // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const blurEffectEnabled = localStorage.getItem('blurEffect') === 'true';
            document.getElementById('blurEffectToggle').checked = blurEffectEnabled;
            setTheme(savedTheme);
            applyBlurEffect(blurEffectEnabled);
        });


        // è·å–å¹¶æ˜¾ç¤ºæˆ¿é—´æ•°æ®
        const fetchRoomData = async (roomId, recType) => {
            try {
                const response = await fetch(`/api/data/${recType}/${roomId}`);
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                const { data } = await response.json();
                displayUserData(data);
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´æ•°æ®é”™è¯¯:', error);
                details.innerHTML = `<p>æ— æ³•åŠ è½½æ•°æ®ï¼Œè¯·ç¨åå†è¯•ã€‚</p>`;
            }
        };


        // åˆ›å»ºåˆ†é¡µæ ‡ç­¾
        function createPaginationTabs(data) {
            const uniqueBaseUrls = [...new Set(data.map(item => item.rec_url))];
            const tabsHtml = uniqueBaseUrls.map((url, index) => `
                <li class="nav-item">
                    <a class="nav-link ${index === 0 ? 'active' : ''}" data-bs-toggle="tab" href="#${url}">${url}</a>
                </li>
            `).join('');
            return `<ul class="nav nav-tabs">${tabsHtml}</ul>`;
        }



        // æ ¼å¼åŒ–å¹¶å±•ç¤ºç”¨æˆ·æ•°æ®
        function displayUserData(userDataArray) {
            let contentHtml = '<div class="tab-content">';
            userDataArray.forEach(userData => {
                const formattedData = userData.rec_tpye === 'recheme'
                    ? formatRechemeData(userData)
                    : formatBlrecData(userData);
                const rawData = JSON.stringify(userData, null, 2);
                contentHtml += `
                    <div class="tab-pane fade ${userData.rec_url === userDataArray[0].rec_url ? 'show active' : ''}" id="${userData.rec_url}">
                        <div class="formatted-data">${formattedData}</div>
                        <details>
                            <summary>åŸå§‹æ•°æ®</summary>
                            <pre><code>${rawData}</code></pre>
                        </details>
                    </div>`;
            });
            contentHtml += '</div>';

            details.innerHTML = createPaginationTabs(userDataArray) + contentHtml;
        }

        // å°†æ—¶é—´è½¬æ¢ä¸ºæ—¶:åˆ†:ç§’æ ¼å¼
        // timeValue: æ—¶é—´æ•°å€¼
        // unit: æ—¶é—´å•ä½ï¼Œ'ms' è¡¨ç¤ºæ¯«ç§’ï¼Œ's' è¡¨ç¤ºç§’
        function formatTime(timeValue, unit) {
            let seconds = unit === 'ms' ? Math.round(timeValue / 1000) : Math.round(timeValue);

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return [hours, minutes, secs]
                .map(val => val < 10 ? `0${val}` : val)
                .join(':');
        }


        // å°†å­—èŠ‚æˆ–æ¯”ç‰¹è½¬æ¢ä¸ºMBå¹¶ä¿ç•™ä¸¤ä½å°æ•°
        // value: æ•°æ®æ•°å€¼
        // unit: æ•°æ®å•ä½ï¼Œ'bytes' è¡¨ç¤ºå­—èŠ‚ï¼Œ'bits' è¡¨ç¤ºæ¯”ç‰¹
        function convertToMB(value, unit) {
            if (unit === 'bits') {
                // å¦‚æœå•ä½æ˜¯æ¯”ç‰¹ï¼Œåˆ™å…ˆè½¬æ¢ä¸ºå­—èŠ‚
                value = value / 8;
            }
            // ç„¶åå°†å­—èŠ‚è½¬æ¢ä¸ºMB
            return (value / (1024 * 1024)).toFixed(2);
        }

        // æ ¼å¼åŒ–'recheme'ç±»å‹çš„æ•°æ®
        function formatRechemeData(data) {
            return `
        <br>
        <div class="data-item">${data.title}</div>
        <hr>
        <div class="data-item"><a href="https://space.bilibili.com/${data.uid}" target="_blank">${data.name}</a> Â· <a href="https://live.bilibili.com/${data.roomId}" target="_blank">${data.roomId}</a></div>
        <div class="data-item">${data.areaNameParent} Â· ${data.areaNameChild}</div>
        <div class="data-item">ç›´æ’­çŠ¶æ€ ${data.streaming ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">å½•åˆ¶çŠ¶æ€ ${data.recording ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">è‡ªåŠ¨å½•æ’­ ${data.autoRecord ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">ä¼šè¯æ—¶é•¿ ${formatTime(data.recordingStats.sessionDuration, 'ms')}</div>
        <div class="data-item">æ€»æ¥å—å­—èŠ‚æ•° ${convertToMB(data.recordingStats.totalInputBytes, 'bytes')} MB</div>
        <div class="data-item">æ€»å†™å…¥å­—èŠ‚æ•° ${convertToMB(data.recordingStats.totalOutputBytes, 'bytes')} MB</div>
        <div class="data-item">å½“å‰æ–‡ä»¶çš„å¤§å° ${convertToMB(data.recordingStats.currentFileSize, 'bytes')} MB</div>

        <div class="data-item">æµæœåŠ¡å™¨ ${data.ioStats.streamHost}</div>
    `;
        }

        // æ ¼å¼åŒ–'blrec'ç±»å‹çš„æ•°æ®
        function formatBlrecData(data) {
            return `
        <br>
        <div class="data-item">${data.room_info.title}</div>
        <hr>
        <div class="data-item"><a href="https://space.bilibili.com/${data.user_info.uid}" target="_blank">${data.user_info.name}</a> Â· <a href="https://live.bilibili.com/${data.room_info.room_id}" target="_blank">${data.room_info.room_id}</a></div>
        <div class="data-item">${data.room_info.parent_area_name} Â· ${data.room_info.area_name}</div>
        <div class="data-item">ç›´æ’­çŠ¶æ€ ${data.room_info.live_status === 1 ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">å½•åˆ¶çŠ¶æ€ ${data.task_status.running_status === "recording" ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">è‡ªåŠ¨å½•æ’­ ${data.task_status.recorder_enabled ? 'ğŸ¥°' : 'ğŸ˜­'}</div>
        <div class="data-item">ä¸‹è½½é€Ÿåº¦ ${convertToMB(data.task_status.dl_rate, 'bits')} MB/s</div>
        <div class="data-item">ä¸‹è½½æ€»è®¡ ${convertToMB(data.task_status.dl_total, 'bits')} MB</div>
        <div class="data-item">å½•åˆ¶é€Ÿåº¦ ${convertToMB(data.task_status.rec_rate, 'bits')} MB/s</div>
        <div class="data-item">å½•åˆ¶æ€»è®¡ ${convertToMB(data.task_status.rec_total, 'bits')} MB</div>
        <div class="data-item">å½•åˆ¶ç”¨æ—¶ ${formatTime(data.task_status.rec_elapsed, 's')}</div>
        <div class="data-item">æµæœåŠ¡å™¨ ${data.task_status.stream_host}</div>
        <div class="data-item">ç›´æ’­æµç±»å‹ ${data.task_status.real_stream_format}</div>
    `;
        }


        // åˆ¤æ–­æ˜¯å¦æ­£åœ¨ç›´æ’­
        const isStreaming = (user) => {
            if (user.rec_tpye === 'recheme') {
                return user.streaming;
            } else if (user.rec_tpye === 'blrec') {
                return user.room_info.live_status === 1;
            }
            return false;
        };

        // æ¯”è¾ƒå‡½æ•°ï¼Œç”¨äºæ’åº
        const compareUsers = (a, b) => {
            const streamingA = isStreaming(a) ? 0 : 1;
            const streamingB = isStreaming(b) ? 0 : 1;
            if (streamingA !== streamingB) return streamingA - streamingB;
            return (a.name || a.user_info.name).localeCompare(b.name || b.user_info.name, ['en', 'ja', 'zh-Hans-CN'], { sensitivity: 'accent' });
        };


        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        const loadUserList = async () => {
            try {
                const response = await fetch('/api/data');
                const { data } = await response.json();

                // ä½¿ç”¨æ›´ç®€æ´çš„æ–¹å¼åˆå¹¶åŒç±»å‹å½•æ’­æœºä¸‹åŒä¸€ä¸ªç”¨æˆ·
                const uniqueUsers = new Map(data.map(user => {
                    const key = `${user.rec_tpye}-${user.rec_tpye === 'recheme' ? user.roomId : user.room_info.room_id}`;
                    return [key, user];
                }));

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('total-users').textContent = data.length;
                document.getElementById('streaming-users').textContent = Array.from(uniqueUsers.values()).filter(isStreaming).length;

                // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
                userList.innerHTML = Array.from(uniqueUsers.values())
                    .sort(compareUsers)
                    .map(user => createUserItem(user))
                    .join('');
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        };

        // åˆ›å»ºç”¨æˆ·åˆ—è¡¨é¡¹
        function createUserItem(user) {
            const name = user.rec_tpye === 'recheme' ? user.name : user.user_info.name;
            const iconClass = user.rec_tpye === 'recheme' ? 'recheme-icon' : 'blrec-icon';
            const streamingClass = isStreaming(user) ? 'streaming' : '';
            return `<div class="user-item ${streamingClass}" onclick="fetchRoomData('${user.rec_tpye === 'recheme' ? user.roomId : user.room_info.room_id}', '${user.rec_tpye}')">
                <div class="${iconClass}"></div>${name}
            </div>`;
        }

        loadUserList();

        // æœç´¢æ¡†
        function filterUsers() {
            const filter = document.getElementById('userSearch').value.toLowerCase();
            const userItems = userList.getElementsByClassName('user-item');

            for (const item of userItems) {
                const isVisible = item.textContent.toLowerCase().includes(filter);
                item.style.display = isVisible ? "" : "none";
            }
        }

    </script>

</body>

</html>